### 가상화 (Virtualization)
> 물리 장치의 리소스를 분할하거나 통합해서 추상화된 논리적인 리소스로 가상화 장치를 만들고, 사용자는 가상화 장치를 물리 장치처럼 사용하는 것이다.

가상화란 서버 한 대를 여러 대의 작은 서버로 나눠 쓰는 것이다.   
이 기술의 핵심은 해당 서버가 가상화인지 물리 서버인지에 대한 차이를 느낄 수 없게 하는 것이다.     
서버 뿐만 아니라 물리적으로 존재하는 CPU, 메모리, NIC(컴퓨터를 네트워크에 연결하여 통신하기 위해 사용하는 하드웨어), 스토리지 등 거의 모든 하드웨어 리소스를 가상화할 수 있다.   
이때 물리적으로 존재하는 하드웨어를 물리 장치, 그것을 논리적으로 연결/분할/통합해서 새로운 장치로 만들어 낸 것을 가상화 장치라고 한다.   
최근에는 물리적 자원과의 성능 차이를 최소화 하기 위한 여러 가상화 기술이 발전되어 그 차이가 거의 줄어들었다.   

### 왜 사용할까?
#### 이유1. 윈도우 서버 기반 인프라 때문이다.   
프로세서가 빨라지고 메모리가 커지면서 IT관리자들이 운용하기 편한 윈도우 서버에서도 강력한 애플리케이션을 운영할 수 있게 되었다.   
그러나 윈도우는 원래 Single-user Interface 운영체제라서 2개 이상의 프로그램을 한 서버에서 실행시키면 심한 자원 경합이 생기고 심지어 장애가 발생하였다.   
때문에 많은 기업들이 모두 하나의 윈도우 서버에 한 개의 애플리케이션만 배치하여 관리하게 된다.   
이 때 서버 1대의 성능도 급격히 증가하는데, 남는 자원의 활용에 대한 필요성이 강해지고 이 요구를 만족시키기 위해 가상화 기술의 대중화가 이루어졌다.   

#### 이유2. E-비즈니스의 수요 증가와 경쟁, 그리고 보안강화 때문이다.
새로운 아이디어를 빠르게 사업화하고 시장 환경 변화를 민첩하게 반응해야 하는 E-비즈니스는 IT리소스를 유연하게 관리할 수 있어야 했다.   
이럴 때 물리 장치를 가상화하여 사용하면 비용 절감이 가능하다.   
또한 자금정보/인사정보/지식재산권 보호 시스템 등 단일 시스템의 규모는 크지 않지만 정보의 가치가 매우 높은 대상들을 완벽히 통제하고 싶을 때도 가상화 기술이 효율적이다.   

#### 이유3. 물리적 한계를 극복하기 위함이다.
인프라 장비가 늘어날수록 케이블, 케이지, 화재 방지 시설 등 모든 장비가 소비하느 전력공급과 발생시키는 열의 배출이 문제가 된다.   
예비전력 용량 부족 등의 문제도 가상화 기술을 통해 상당 부분 해소할 수 있다.   

### 가상화 방식을 알아보자
1. 공유 가상화 (Sharing)
> 대표적인 방식으로, 다수의 가상 자원을 하나의 물리적 자원과 연결시켜서 시간 분할 기법으로 물리적 자원을 공유하는 방법이다. / ex : TDMA(Time-Division Multiple Access)
2. 집합 가상화 (Aggregation)
> 여러 개의 자원을 하나로 묶어서 물리적 용량과 성능을 향상시키고, 하나의 논리 장치로 관리할 수 있도록 하는 방법이다. / ex : MLAG(Multi-Classis Link Aggregation)
3. 에뮬레이션 (Emulation)
> 하드웨어 리소스의 동작을 소프트웨어로 대신하는 방식이다. 에뮬레이터 내 소프트웨어는 자신이 하드웨어를 통해 실행되는 것으로 인지하지만, 사실은 다른 소프트웨어에 의해 실행된다. 어떤 운영체제라도 모두 인식할 수 있다는 장점이 있다.
4. 자원 절연 (Resource Insulation)
> 물리 장치가 비정상인 상태에서도 논리 장치의 고가용성은 보장되는 방법이다. / ex : RAID, 멀티패스 기능

### 서버 가상화의 핵심, 하이퍼바이저와 VM(Virtual Machine)
하이퍼바이저는 여러 개의 VM이 한정된 하드웨어 자원을 나눠 쓸 수 있도록 여러 개의 VM이 동시에 수행될 수 있는 환경을 제공한다.   
운영체제와 합쳐져 있는 형태를 타입 1, 분리된 형태를 타입 2라고 부른다.   
타입 1의 경우에는 운영체제가 설치되어 있지 않은 베어메탈 서버에 설치하며, 타입 2는 사전에 별도 운영체제를 설치한 뒤에만 설치가 가능하다.   
하이퍼바이저 역할 범위는 아래와 같이 2가지로 나뉜다.   
- 전가상화(Full Virtualization) : 하이퍼바이저가 호스트 운영체제에서 모든 일을 처리하는 것
- 반가상화(Para-Virtualization) : 하이퍼바이저가 일부 역할을 VM의 도움을 받아 처리하는 것
전가상화는 하이퍼바이저를 통해 하드웨어에 직접 접근하기 때문에 게스트 운영체제를 베어메탈 서버에 설치하는 운영체제와 같은 버전으로 사용할 수 있다는 것이 큰 장점이다.   
이를 위해 전가상화 제품들은 모든 장치에 대한 드라이버를 에뮬레이션 가상화 기법으로 제공하고 바이너리 변환 기법을 통해 하드웨어에 대한 커널 수준 접근(커널과 같은 수준의 권한으로 하드웨어에 접근)을 가능하게 한다.   
반가상화는 게스트 운영체제가 완전히 독립적인 수행 환경을 보장받지 못하기 때문에 운영체제를 그대로 사용할 수 없고, 게스트 운영체제가 반가상화 환경에 맞게 개선되어야 한다.   

### 컨테이너 구조
Paas(Plaform as a Service)에서 주목받고 있는 가상화 방식이다.   
VM이 없으며, 게스트 운영체제도 없다.   
VM에 대한 하드웨어 초기화 작업이 필요 없기 때문에 가상 환경 시작/종료 시간이 매우 빠르고 오버헤드도 거의 없다.   
그럼에도 불구하고 다른 가상화 환경과 동일하게 프로세스를 수행할 수 있는 독립된 공간을 제공한다.   
또한 호스트 운영체제와 다른 리눅스 컨테이너에서 들여다볼 수 없기 때문에 보안적으로도 우수하다.   
더불어 다른 가상화 환경에 비해 밀도 높은 설계가 가능하며, 요구되는 하드웨어 자원 수준도 낮다.   
단점은, 호스트 운영체제인 리눅스 외의 다른 운영체제에서는 동작하지 않고 리눅스 계열 외의 운영체제를 설치할 수 없다는 것이다.   
Paas는 독립적인 애플리케이션 수행 환경을 서비스 형태로 제공하는 것을 말하는데, 이를 제공하면서도 가상 오버헤드가 제일 적은 컨테이너 방식이 가상화 서비스에 어울리는 것이다.   
최근에는 거의 모든 솔루션이 리눅스와 호환성을 가지고 있어서 리눅스 운영체제만 사용한다는 점이 한계가 되지 않는다.   

### 서버 가상화
서버를 가상화하는 기술을 사용해서 한 대의 베어메탈 서버에 여러 대의 가상 시스템으로 만드는 것을 의미한다.   
가상화 서버를 구축하는 순서는 아래와 같다.   
1. 시스템에서 수행될 애플리케이션의 워크로드 패턴(애플리케이션이 수행하는 동안 소모하는 인프라자원-CPU,메모리,I/O-에 대한 사용형태와 사용량) 분석
   - CPU를 몇 개 할당해야 하는가 -> 애플리케이션이 다중 스레드인가 단일 스레드인가 -> 다중 스레드라면 몇 개의 코어를 사용할 때 성능이 좋은가
   - CPU별 코어 사용량은 어떻게 확인하는가 -> 운영체제 모니터링 툴(윈도우 리소스 모니터, 리눅스 top 명령)로 확인
2. 비기능 요구사항(NFR, 비즈니스 기능과 무관한 시스템 자체 조건으로 TPS가 대표적임) 수집
3. 시스템 용량 분석
4. 논리 설계와 물리 설계 진행
가상화 서버에서는 오버커밋이 발생할 수 있는데, 물리적 용량 한계를 넘어서 할당하는 개념이다.이 비율이 높으면 자원 경합에 의한 성능 지연이 발생할 수 있다.   
따라서 기업에서는 회사의 주된 사업에 도입하기보다는 개발서버나 신규 사업군, 성능에 민감하지 않은 사업에 많이 도입한다.   

### 메모리 가상화
메모리에도 오버커밋이 있다.   
CPU는 시간을 소비하는 것이라 언젠가는 처리 순번이 돌아오지만 메모리는 공간을 차지하는 것이라 먼저 메모리 공간을 차지한 VM이 메모리를 해제하거나 재기동하기 전까지는 메모리 공간을 할당받지 못한다.   
따라서, CPU보다 더 보수적으로 설계하여 오버커밋을 아예 방지하는 것이 좋다.   
메모리가 부족하면 SWAP이 발생하고, 메모리가 부족한 하이퍼바이저상의 모든 VM의 성능이 저하되기 때문이다.   
또한 리눅스는 디스크보다 상대적으로 빠른 메모리에 많은 데이터를 미리 적재하여 사용하는 구조이기 때문에, 오버커밋하면 필연적으로 물리 메모리를 초과하게 되기 때문에 문제가 된다.   
메모리 가상화의 한계를 넘기위해 나온 기술은 아래와 같다.
1. 씬 프로비저닝
   - VM에는 가상 메모리 주솟값을 할당하고 VM에서 실제 메모리를 사용할 때 물리 메모리를 조금씩 할당하는 방법
   - 메모리 단편화가 발생하는 단점이 있다.
2. 벌룬 드라이버
   - 풍선 효과(풍선의 한쪽을 누르면 다른 쪽이 부푸는 현상)와 비슷하다.
   - VM에 할당된 메모리 전체를 풍선이라 생각하고 한쪽(물리 메모리로 할당된 메모리 영역)을 꽉 쥐면(줄이면) 자연스럽게 다른 한쪽(디스크로 할당된 메모리 영역)이 부풀어서 공기(VM 메모리)가 한쪽(물리 메모리 영역)에서 다른 한쪽(디스크 영역)으로 이동하는 방식
   - 메모리가 물리 메모리와 디스크 간 상호 이동을 하며 전체 크기가 유지된다.
   - 리눅스의 SWAP 메모리와 비슷하다.
3. COW(Copy on Write)
   - VM을 복제할 때, 메모리를 동일하게 복제하지 않고 2개의 VM이 동일한 메모리 영역을 참조하다가 데이터가 변경되는 시점에서 새로운 메모리를 할당하여 사용하는 방법
4. 압축 캐시
   - VM에서 메모리를 사용할 때 VM과 물리 메모리 사이에 별도의 캐시 메모리를 두고, 그 캐시에 데이터를 임시 저장한 후 압축해서 실제 물리 메모리에 저장하는 방법
   - 디스크 디바이스를 사용한다는 한계를 가진 벌룬 드라이버보다는 빠르다.
   - 데이터 형태에 따라 압축률이 다르고 압축/해제 연산을 하기 때문에 CPU 사용률이 높다는 단점이 있다. (= CPU를 사용해서 메모리를 늘리는 것)

### 스토리지 가상화
서버 가상화 환경을 구성할 때는 대체로 공유 스토리지를 사용한다.(특히 SAN 방식)   
VM은 하드웨어 구성 정보부터 운영체제, 애플리케이션 데이터까지 모두 스토리지에 저장되기 때문에 공유 스토리지로 구성하면 스토리지를 공유하는 하이퍼바이저 간 VM을 이동시키면서 가용성을 확보할 수 있기 때문이다.

### 네트워크 가상화
서버 가상화 환경을 구성할 때 네트워크 구성 방식은 2가지 이다.   
1. 외부와 통신 가능한 외부 네트워크 (하이퍼바이저 밖의 네트워크에 연결)
2. 외부와 통신 불가능한 내부 네트워크 (서버 가상화 환경 내 서버들 간의 통신 환경 제공)
서버 가상화 환경이 구축되면, 네트워크 복잡도가 올라가기 때문에 장애원인 분석/악의적 공격에 대한 포렌식/공격차단을 위한 네트워크 자원 제어가 가능하도록 IP를 구성해야 한다.

### VM 복제 기술
VM의 가장 큰 장점이 하드웨어 구성부터 애플리케이션까지 모두 데이터로 저장된다는 것이다.   
따라서 잘 만든 VM으로 템플릿을 만들고, 필요할 때마다 배포하는 방식이 가능하다. (클라우드의 핵심 기술)   
또한, 같은 VM을 만드는 복제 기술과 VM의 시점별 이미지 데이터를 만드는 스냅샷이라는 기술도 있다.   


### Reference
정송화, 김영선, 전성민, '개발자도 궁금한 IT 인프라'
